---
title: "HOMEWORK 1 - Creating Value Through Data Mining (S402010)"
author: "Liam Phan"
date: "`r Sys.Date()`"
output: html_document
---

# HOMEWORK 1 

## Settings Up

```{r 1, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
rm(list = ls()) # clean environment
```

# Loading Packages

```{r 2, warning=FALSE, message=FALSE }

# Loading Packages 

library(data.table)
library(lubridate)
library(tidyverse)
library(esquisse)
library(plyr)
library(ggplot2)
library(cowplot)
library(naniar) #for NA exploration
library(sp) #spatial data
library(reshape2)
library(plotly)
library(gissr)
library(leaflet)

```

## Loading Datas and Cleaning

```{r 3, fig.asp = 0.8, fig.width = 7}

Laptop_Sales_Data <- fread("DATA/LaptopSales_red.csv")

#is.data.table(Laptop_Sales_Data)

#summary(Laptop_Sales_Data)

#str(Laptop_Sales_Data)

gg_miss_var(Laptop_Sales_Data, show_pct = TRUE)

```

## EX 3.4 

### a.Price Questions:

```{r 4, fig.asp = 0.8, fig.width = 7, include=FALSE}

#### Set Up a Data Subset and NA OMIT

Retail_Price_and_Dates <- Laptop_Sales_Data[,.(Retail.Price,Date)][,Date:=mdy_hm(Date)]

Retail_Price_and_Dates <- na.omit(Retail_Price_and_Dates)

```


#### i. At What Price are the laptops actually selling ?


```{r 5, fig.asp = 0.8, fig.width = 7, echo=FALSE}

#### Histogram of the Retail Price of Computer In 2018

ggplot(Retail_Price_and_Dates) +
 aes(x = Retail.Price) +
 geom_histogram(bins = 30L, fill = "#1c6155") +
 labs(x = "Price", y = "Frequency", title = "Histogram of the Retail Price of Computer", subtitle = "In 2018") + theme_classic()

```


```{r 51, fig.asp = 0.8, fig.width = 7,echo=FALSE}

#### Boxplot of the Retail Price of Computer In 2018

ggplotly(
ggplot(Retail_Price_and_Dates) +
 aes(x = "", y = Retail.Price) +
 geom_boxplot(fill = "#1c6155") +
 labs(y = "Price", x="",
 title = "Boxplot of the Retail Price of Computer", subtitle = "In 2018") +
 theme_classic()
)

```


```{r 52, fig.asp = 0.8, fig.width = 7, include=FALSE}

# Actual price

Max_Date_Retail <- max(Retail_Price_and_Dates$Date)

Actual_Price <- Retail_Price_and_Dates[Date %in% Max_Date_Retail, ]

```

```{r 53, fig.asp = 0.8, fig.width = 7,echo=FALSE}

print(paste("Last Recorded Prices are", Actual_Price[1,1], "USD", "and", Actual_Price[2,1],"USD","on the same Day with a mean of",mean(Actual_Price$Retail.Price),"USD"))

```


#### ii.Does price change with time?


```{r 61, fig.asp = 0.8, fig.width = 7, include=FALSE}

# Aggregating by Month
Retail_Price_and_Dates_Month <- Retail_Price_and_Dates[, mean(Retail.Price), by = floor_date(Date,unit="month")]

colnames(Retail_Price_and_Dates_Month)[1] <- "Date"
colnames(Retail_Price_and_Dates_Month)[2] <- "Mean_Retail_Price"

# Aggregating by Week
Retail_Price_and_Dates_Week <- Retail_Price_and_Dates[, mean(Retail.Price), by = floor_date(Date,unit = "week")]

colnames(Retail_Price_and_Dates_Week)[1] <- "Date"
colnames(Retail_Price_and_Dates_Week)[2] <- "Mean_Retail_Price"

# Aggregating by Day
Retail_Price_and_Dates_Day <- Retail_Price_and_Dates[, mean(Retail.Price), by = floor_date(Date,unit = "day")]

colnames(Retail_Price_and_Dates_Day)[1] <- "Date"
colnames(Retail_Price_and_Dates_Day)[2] <- "Mean_Retail_Price"

# Aggregating by Weekday

Retail_Price_and_Dates_WeekDay <- Retail_Price_and_Dates[,Weekday:=weekdays(Date)]
Retail_Price_and_Dates_WeekDay <- Retail_Price_and_Dates_WeekDay[,mean(Retail.Price),by=Weekday]

Retail_Price_and_Dates_WeekDay$Weekday <- factor(Retail_Price_and_Dates_WeekDay$Weekday, ordered = TRUE, levels=(c("Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche")))

colnames(Retail_Price_and_Dates_WeekDay)[2] <- "Mean_Retail_Price"

```


```{r 6, fig.asp = 0.8, fig.width = 7, echo=FALSE}

# Retail Price By Month
RetailPricePlot1 <- ggplotly(
  ggplot(Retail_Price_and_Dates_Month) +
 aes(x = Date, y = Mean_Retail_Price) +
 geom_line(size = 1.1, 
 colour = "#1c6155") + geom_point() +
 labs(x = "Months", y = "Average Retail Pric", title = "Average Retail Price of Computer in 2018", 
 subtitle = "Aggregated by Month") +
 theme_classic()
 )

RetailPricePlot1

# Retail Price By Week
RetailPricePlot2 <- ggplotly(
  ggplot(Retail_Price_and_Dates_Week) +
 aes(x = Date, y = Mean_Retail_Price) +
 geom_line(size = 0.4, 
 colour = "#1c6155") + geom_point() +
 labs(x = "Weeks", y = "Average Retail Pric", title = "Average Retail Price of Computer in 2018", 
 subtitle = "Aggregated by Week") +
 theme_classic()
 )

RetailPricePlot2

# Retail Price By Day
RetailPricePlot3 <- ggplotly(
  ggplot(Retail_Price_and_Dates_Day) +
 aes(x = Date, y = Mean_Retail_Price) +
 geom_line(size = 0.2, 
 colour = "#1c6155")  +
 labs(x = "Days", y = "Average Retail Price", title = "Average Retail Price of Computer in 2018", 
 subtitle = "Aggregated by Day") + 
 theme_classic()
 )

RetailPricePlot3

# Retail Price By Week Day

RetailPricePlot4 <- ggplotly(
  ggplot(Retail_Price_and_Dates_WeekDay) +
 aes(x = Weekday, y = Mean_Retail_Price) +
 geom_col(fill = "#1c6155") +
 labs(x = "Weekdays", y = "Average Retail Price", title = "Average Retail Price during Weekdays", subtitle = "In 2018") + 
 theme_classic() + coord_cartesian(ylim = c(505, 510))
)

RetailPricePlot4

```


#### iii. Are prices consistent across retail outlets?


```{r 7, fig.asp = 0.8, fig.width = 7, include=FALSE}

#### Set Up a Data Subset and NA OMIT

Retail_Price_Outlets_Date <- Laptop_Sales_Data[,.(Retail.Price,Store.Postcode,Date)][,Date:=mdy_hm(Date)]

Retail_Price_Outlets_Date  <- na.omit(Retail_Price_Outlets_Date)

Retail_Price_Configuration <- Laptop_Sales_Data[,.(Retail.Price,Configuration,Screen.Size..Inches.,Battery.Life..Hours.,RAM..GB.,Processor.Speeds..GHz.,Integrated.Wireless.,HD.Size..GB.,Bundled.Applications.)]

Retail_Price_Configuration <- na.omit(Retail_Price_Configuration)

```


```{r 8, fig.asp = 0.8, fig.width = 7,echo=FALSE}

#### Boxplot Across Retail Outlets

ggplotly(
ggplot(Retail_Price_Outlets_Date) +
 aes(x = Store.Postcode, y = Retail.Price) +
 geom_boxplot(fill = "#1c6155") +
 labs(x = "Stores Postcode", y = "Price", title = "Boxplot Of The Retail Price Across Stores", subtitle = "In 2018") +
 theme_classic() + scale_x_discrete(guide = guide_axis(n.dodge = 1)) + theme(axis.text.x=element_text(size=rel(1), angle=90))
)

```


```{r 81, fig.asp = 0.8, fig.width = 7, include=FALSE}

#### Retail Price Across Stores During 2018 - Data

Retail_Price_Outlets_Date_Month <- Retail_Price_Outlets_Date[,Floor.Date:=floor_date(Date,unit="month")][,c(Mean_Price=mean(Retail.Price)), by=list(Store.Postcode,Floor.Date)]

colnames(Retail_Price_Outlets_Date_Month)[3] <- "Mean_Retail_Price"

```


```{r 83, fig.asp = 0.8, fig.width = 7,echo=FALSE}

#### Plot of the Monthly Retail Price per Stores

ggplot(Retail_Price_Outlets_Date_Month) +
 aes(x = Floor.Date, y = Mean_Retail_Price, colour = Store.Postcode) +
 geom_line(size = 0.5) +
 scale_color_hue(direction = 1) +
 labs(x = "Month", y = "Price", title = "Retail Price Across Months and Grouped by Stores", 
 subtitle = "In 2018") +
 theme_classic() 

```


#### iv. How does price change with configuration?


```{r 82, fig.asp = 0.8, fig.width = 7,echo=FALSE} 

#### Plot Of The Retail Price per Configuration

ggplot(Retail_Price_Configuration) +
 aes(x = Configuration, y = Retail.Price) +
 geom_point(shape = "circle", size = 0.6) +
 scale_color_gradient() +
 labs(y = "Retail Price", title = "Retail Price and Configuration ", 
 subtitle = "In 2018") + geom_smooth() + theme_classic()

``` 


### b.Location Questions


#### i. Where are the stores and customers locatd?


```{r 9, fig.asp = 0.8, fig.width = 7,echo=FALSE} 

#Transform UK to Worldwide Geodata

## For Client Data

Data_Client_Coordinates <- Laptop_Sales_Data[,.(customer.X,customer.Y)]

Data_Client_Coordinates <- na.omit(Data_Client_Coordinates)

Data_Client_Coordinates <- transform_coordinates(Data_Client_Coordinates,
                                                        latitude="customer.X",longitude = "customer.Y", from = projection_bng(), to = projection_wgs84())

## For Store Data

Data_Stores_Coordinates <- Laptop_Sales_Data[,.(store.X,store.Y)]

Data_Stores_Coordinates <- na.omit(Data_Stores_Coordinates)

Data_Stores_Coordinates <- transform_coordinates(Data_Stores_Coordinates,
                                                        latitude="store.X",longitude = "store.Y", from = projection_bng(), to = projection_wgs84())

```


```{r 82, fig.asp = 0.8, fig.width = 7,echo=FALSE} 

#Ploting Map 

leaflet(data = Data_Stores_Coordinates) %>% addTiles() %>%
  addMarkers(~store.X, ~store.Y, popup = ~as.character(St), label = ~as.character(mag))






```


#### ii. Which stores are selling the most?


```{r 10, fig.asp = 0.8, fig.width = 7, include=FALSE}

Laptop_Sales_Data_2 <- Laptop_Sales_Data

Sales_Stores <- Laptop_Sales_Data_2[, .N, by=Store.Postcode]

Sales_Stores_2 <- Laptop_Sales_Data_2[,.(Revenues=sum(Retail.Price, na.rm = TRUE)),by=Store.Postcode]

```


```{r 103, fig.asp = 0.8, fig.width = 7,echo=FALSE}

#### Plot Transactions per Stores

ggplot(Sales_Stores) +
 aes(x = reorder(Store.Postcode,-N), y = N) +
 geom_col(fill = "#1c6155") +
 labs(x = "Stores", 
 y = "Number Of Transactions", title = "Number of Transactions per Store", subtitle = "In 2018") +
 theme_classic()  + geom_text(aes(label = N), vjust = 1.5, hjust=1.1, colour = "white", angle=90,size=3) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Plot Revenues per Stores
ggplot(Sales_Stores_2) +
 aes(x = reorder(Store.Postcode,-Revenues), y = Revenues) +
 geom_col(fill = "#1c6155") +
 labs(x = "Store Postcode", 
 y = "Revenues", title = "Revenues per Stores", subtitle = "In 2018") + geom_text(aes(label = Revenues), vjust = 1.5, hjust=1.1, colour = "white", angle=90,size=3) + 
 theme_classic()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


#### iii. How far stores are selling the most?


```{r 11}



```


#### iv. How far stores are selling the most? - Alternative


```{r 111}



```


### c.Revenue Questions


#### i. How do the sales volume in each store relate to Acell's revenues?


```{r 12, fig.asp = 0.8, fig.width = 7, include=FALSE}

Sales_Stores_Revenues <- Laptop_Sales_Data[,.(Revenues=sum(Retail.Price, na.rm = TRUE)), by= Store.Postcode]

Total_Revenue <- sum(Sales_Stores_Revenues$Revenues)

Sales_Stores_Revenues <- Sales_Stores_Revenues[,Percentage_Revenue:=Revenues/Total_Revenue]

Sales_Stores_Revenues$Percentage_Revenue <- Sales_Stores_Revenues$Percentage_Revenue*100

```


```{r 121, fig.asp = 0.8, fig.width = 7,echo=FALSE}

ggplot(Sales_Stores_Revenues) +
 aes(x = reorder(Store.Postcode,-Percentage_Revenue), y = Percentage_Revenue) +
 geom_col(fill = "#1c6155") +
 labs(x = "Store Postcode", y = "% of Total Revenues", title = "Revenues Contribution per Stores", 
 subtitle = "In 2018") + 
 theme_classic()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +geom_text(aes(label = round(Percentage_Revenue,1)), vjust = 1.5, hjust=1.1, colour = "white", angle=90,size=3)

```


#### ii. How does this relationship depend on the configuration?


```{r 13,fig.asp = 0.8, fig.width = 7}





```


### d.Configuration Questions 


#### i. What are the details of each configuration? How does this relate to price?


```{r 14, fig.asp = 0.8, fig.width = 7, include=FALSE}

Detail_Price <- Laptop_Sales_Data[,.(Retail.Price,Screen.Size..Inches.,Battery.Life..Hours.,RAM..GB.,Processor.Speeds..GHz.,HD.Size..GB.)]

Detail_Price <- na.omit(Detail_Price)

```


#### ii. Do all stores sell all configurations?


```{r 15,fig.asp = 0.8, fig.width = 7, include=FALSE}

Stores_Details <- Laptop_Sales_Data[,.(Store.Postcode,Configuration)]

Stores_Details <- na.omit(Stores_Details)

Stores_Details$Configuration <- as.integer(Stores_Details$Configuration)

```


```{r 151,fig.asp = 0.8, fig.width = 7,echo=FALSE}

ggplot(Stores_Details) +
 aes(x = Configuration) +
 geom_histogram(bins = 30L, fill = "#1c6155") +
 labs(x = "Stores ", 
 y = "Configurations Count", title = "Each Configurations per Stores", subtitle = "In 2018") +
 theme_classic() +
 facet_wrap(vars(Store.Postcode), scales = "free")

```

